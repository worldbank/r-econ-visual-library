---
pagetitle: 'BarPlotsCombineTwoAxes'
author: ''
date: ''
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Overview

Create a food-group wise set of bar plots, displaying average number of foods from each group consumed last month on one axis, and total value of expenditures on the other, by month. 

```{r}
# Install and load packages ---------------------------
packages <- c(
  "tidyverse",
  "haven",
  "grid",
  "gridExtra",
  "cowplot"
)
# Change to install = TRUE to install the required packages
pacman::p_load(packages, character.only = TRUE, install = FALSE)
```

# Data

This graph is based on Christian, Paul, and Brian Dillon. 2018. "Growing and Learning When Consumption Is Seasonal: Long-Term Evidence From Tanzania." Demography 55 (3): 1091â€“1118. doi:10.1007/s13524-018-0669-4. 

The dataset used is a mock dataset based on the original paper's data. It contains data at the food type-month level. The relevant variables are:

- `int1mo`: Month of interview identifier 
- `food_group`: Food group identifier 
- `number_group`: Mean number of food type consumed in given month 
- `total_exp`: Total expenditures on food group in given month

```{r}
# Load data  ---------------------------
data <- read_dta("https://github.com/worldbank/r-econ-visual-library/raw/master/Library/Data/BarPlotsCombineTwoAxes.dta")

# Printing the first five rows of the data to visualize its structure before data wrangling
head(data)
```

```{r}
# Data wrangling ---------------------------

# Creating a vector of observations with appropriate labels 
food_group_list <- c("animal", "fruit", "grain", "veg", "starch", "processed_sugar")
food_label_list <- c(
  animal = "Animal Sourced",
  fruit = "Fruit",
  grain = "Grain",
  veg = "Vegetable",
  starch = "Starchy Foods",
  processed_sugar = "Processed Sugar"
  )

# Filtering data to the observations of interests
fig_data <- data %>%
  filter(food_group %in% food_group_list) %>%
  mutate(food_group = recode_factor(food_group, !!!food_label_list))

# 72 observations of 144 were kept 

# Printing the first five rows of the data to visualize its structure after data wrangling
head(fig_data)
```

```{r}
# Create a graph ---------------------------

# Basic Graph of Bar Plots by Food Group 
ggplot(fig_data) +
   geom_bar(aes(x = int1mo,
               y = number_group), 
            stat = "identity", #Data is already in mean format
            alpha = .6, # transparency
            width = .4 # bar width
            ) +
   geom_hline(yintercept = 0, alpha = 0.5) + 
  coord_cartesian(ylim = c(0, 3.3)) + # Set Y-axis scale
  scale_x_continuous(breaks = c(3, 6, 9, 12)) + # Set X-axis intervals 
  theme_classic() +
  facet_wrap(~food_group, strip.position = "top") + # Separate graphs by by food groups 
labs(
    title = "",
    x = "Month of Interview",
    y = "Avg. Number of Foods from \n Group Consumed Last Month (bar)"
    )
```

```{r}
# Refined graph including a second axis of total expenditures and cleaner labeling 
ggplot(fig_data) +
# fine tuning the graph using alpha and width options
  geom_bar(aes(x = int1mo,
               y = number_group), 
            stat = "identity", # Data is already in mean format
            alpha = .6, # transparency
            width = .4 # bar width
            ) +
  geom_line(aes(x = int1mo, y = total_exp / 1000)) + # Add line to visualize expenditures
  scale_y_continuous(
    # sec.axis is a convenient option to create a second axis
    sec.axis = sec_axis(~.*1000,  name = "Total Value of Exp. 1,000 Real Tz Sh. (line)"), 

    expand = c(0, 0)
    ) +
  geom_hline(yintercept = 0, alpha = 0.5) +
  coord_cartesian(ylim = c(0, 3.3)) + # Set Y-axis scale 
  scale_x_continuous(breaks = c(3, 6, 9, 12)) + # Set X-axis intervals 
  theme_classic() +
  labs(
    title = "",
    x = "Month of Interview",
    y = "Avg. Number of Foods from \n Group Consumed Last Month (bar)"
    ) +
  facet_wrap(~food_group, strip.position = "top") + # Separate graphs by by food groups 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    strip.placement = "outside"
    )

```
