---
pagetitle: "Density Plots: Density by rounds and by group with ridgelines"
author:
date: 
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Overview

Create group-wise density plots (Control, Cash, In-Kind) of firms' profit measurements by rounds of data collection.

```{r, fig.path = '../docs/figure/', warning = FALSE}
# Install and load packages ---------------
packages <- 
  c("tidyverse",
    "haven",
    "ggridges")

# Change to install = TRUE to install the required packages
pacman::p_load(packages, character.only = TRUE, install = FALSE)
```

# Data

This graph comes from David McKenzie, World Bank; Marcel Fafchamps, Stanford University; Simon Quinn, University of Oxford; Christopher Woodruff, University of Warwick. Ghana Microenterprise Growth and the Flypaper Effect, Randomized Experiment (MGFERE) 2008-2010.

https://microdata.worldbank.org/index.php/catalog/2249

- `sheno`: Firm ID
- `wave`: Survey wave identifier 
- `timetreat`: Treatment identifier 
- `control`: Timing (baseline or follow-up) identifier 
- `realfinalprofit`: Firm profit

- Unit of Observation: Households

```{r, fig.path = '../docs/figure/', warning = FALSE}
# Data wrangling ---------------
data <- 
  read_dta("https://github.com/worldbank/r-econ-visual-library/raw/master/Library/Data/ReplicationDataGhanaJDE_short.dta")

# Printing the first five rows of the data to visualize its structure before data wrangling
head(data)
```

```{r, fig.path = '../docs/figure/', warning = FALSE}
# For simplicity, we will include only those who received treatment between 2nd and 3rd waves in the treatment group.
analysis_data <- 
  data %>%
  filter(wave >= 2) %>% # Only keep survey waves 2 and higher 
  group_by(sheno) %>% # Group observations by firm 
  mutate(treatment = max((wave == 3) & (timetreat == 1)), # Define treatment. "max" allows you to take the larger of two different values 
         control = all(control == 1)) %>% # Set control variable 
  filter(treatment == TRUE | control == TRUE) %>% # Keep observations defined as control & treatment 
  ungroup() %>%
  mutate(treatment_group = ifelse(cashtreat == 1, # Add labels to treatment types 
                                  "Cash",
                                  ifelse(equiptreat == 1,
                                         "In-kind", 
                                         "Control")))
```

```{r, fig.path = '../docs/figure/', message = FALSE, warning = FALSE}
# Create graph ---------------
ggplot(analysis_data, 
       aes(x = realfinalprofit,
           y = fct_rev(factor(wave)), 
       color = factor(treatment_group), 
       fill = factor(treatment_group))) +
  geom_density_ridges(alpha = 0.1, 
                      scale = 1) +
  theme_ridges() + # Set theme to ridgelines 
  xlab("3-month Real Profit (cedi)") +
  ylab("Rounds") +
  scale_color_brewer(palette = "Set2", 
                     name = "Group", 
                     breaks = c("Control", "Cash", "In-kind")) +
  scale_fill_brewer(palette = "Set2",
                    name = "Group", 
                    breaks = c("Control", "Cash", "In-kind")) +
  xlim(c(0, 250))

```
